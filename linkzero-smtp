#!/bin/bash
#
# LinkZero SMTP Runtime Wrapper
# Canonical runtime that delegates to local or repository script
#
# This wrapper:
# - Checks for local disable_smtp_plain.sh and executes it if present and executable
# - Otherwise streams the original from repository and executes it
# - Maintains backward compatibility while providing robust runtime
#

set -euo pipefail

# Repository URL for the original script
REPO_SCRIPT_URL="https://raw.githubusercontent.com/astinowak-wq/LinkZero/main/disable_smtp_plain.sh"
LOCAL_SCRIPT="./disable_smtp_plain.sh"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" >&2
}

# Check if local script exists and is executable
if [[ -f "$LOCAL_SCRIPT" ]] && [[ -x "$LOCAL_SCRIPT" ]]; then
    log_info "Using local disable_smtp_plain.sh"
    exec "$LOCAL_SCRIPT" "$@"
else
    log_info "Local script not found or not executable, streaming from repository"
    
    # Detect available download tool
    if command -v curl >/dev/null 2>&1; then
        DOWNLOAD_CMD="curl -sSL"
    elif command -v wget >/dev/null 2>&1; then
        DOWNLOAD_CMD="wget -qO-"
    else
        log_error "Neither curl nor wget found. Please install one of them."
        exit 1
    fi
    
    # Create a temporary script file
    TEMP_SCRIPT=$(mktemp)
    trap 'rm -f "$TEMP_SCRIPT"' EXIT
    
    # Download the script
    if ! $DOWNLOAD_CMD "$REPO_SCRIPT_URL" > "$TEMP_SCRIPT"; then
        log_error "Failed to download script from repository"
        exit 1
    fi
    
    # Verify the downloaded script has the proper shebang
    if ! head -n1 "$TEMP_SCRIPT" | grep -q "^#!/bin/bash"; then
        log_error "Downloaded script does not appear to be a valid shell script"
        exit 1
    fi
    
    # Make it executable and execute
    chmod +x "$TEMP_SCRIPT"
    log_info "Executing repository script with arguments: $*"
    exec "$TEMP_SCRIPT" "$@"
fi